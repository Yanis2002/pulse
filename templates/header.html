<header class="pulse-header">
    <div class="header-left">
        <a href="/" class="logo-link"><img src="{{ url_for('static', filename='pulse_logo_transparent.png') }}" class="logo-header" alt="PULSE"></a>
        <div class="site-title">
            <div class="title-main">PULSE <span class="title-accent">| CLUB</span></div>
        </div>
    </div>
    <nav class="header-nav">
        <a href="/" class="nav-btn">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/rating" class="nav-btn">–†–µ–π—Ç–∏–Ω–≥</a>
        <a href="/timer" class="nav-btn">–ë–ª–∞–π–Ω–¥—ã</a>
        <a href="/contacts" class="nav-btn">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
        <a href="javascript:void(0)" class="nav-btn music-icon-btn" id="music-toggle" title="–ú—É–∑—ã–∫–∞">
            <span class="music-icon">üîä</span>
        </a>
        <a href="javascript:void(0)" class="nav-btn profile-btn" id="profile-toggle" title="–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç">
            <span class="profile-icon">üë§</span>
        </a>
    </nav>
</header>
<style>
.pulse-header {
    width: 100vw;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2vw;
    min-height: 10vh;
    padding: 1.7vh 2vw 1.7vh 2vw;
    background: linear-gradient(120deg, #2c003e 0%, #280819 28%, #5d1e26 62%, #a4223a 91%, #450330 100%);
    box-shadow: 0 3px 16px 2px rgba(90,15,60,0.13);
    position: relative;
    z-index: 100;
}
.logo-header {
    height: 7vh;
    width: 7vh;
    min-width: 42px;
    min-height: 42px;
    object-fit: contain;
    border-radius: 16px;
    box-shadow: 0 0 16px #450330;
    transition: filter 0.25s;
}
.logo-link { display:block; }
.site-title {
    display: flex;
    flex-direction: column;
    gap: 0.4vh;
    margin-left: 1.2vw;
}
.title-main {
    font-weight: 900;
    font-size: 2.8vh;
    letter-spacing: 0.17em;
    text-transform: uppercase;
    color: #ff4b5c;
    text-shadow: 0 0 18px #52021e99, 0 0 50px #74212f44;
}
.title-accent {
    color: #fff;
    text-shadow: 0 0 14px #d8192990;
}
.header-left { display:flex; align-items: center; }
.header-nav { display: flex; gap: 1vw; }
.nav-btn {
    padding: 0.9vh 2vw;
    border-radius: 999px;
    border: none;
    background: rgba(255,65,90,0.06);
    color: #ffe6eb;
    font-size: 1.5vh;
    font-weight: 700;
    letter-spacing: 0.13em;
    text-transform: uppercase;
    cursor: pointer;
    text-decoration: none;
    box-shadow: 0 0 16px #31011312;
    transition: filter 0.17s, background 0.17s;
}
.nav-btn:hover {
    background: rgba(255,46,59,0.17);
    color: #fff;
    filter: brightness(1.23);
}
.music-icon-btn {
    padding: 0.9vh 1.5vw !important;
    font-size: 2.2vh !important;
    display: flex;
    align-items: center;
    justify-content: center;
}
.music-icon {
    display: inline-block;
    transition: transform 0.2s;
}
.music-icon-btn:hover .music-icon {
    transform: scale(1.1);
}
.profile-btn {
    padding: 0.9vh 1.5vw !important;
    font-size: 2.2vh !important;
    display: flex;
    align-items: center;
    justify-content: center;
}
.profile-icon {
    display: inline-block;
    transition: transform 0.2s;
}
.profile-btn:hover .profile-icon {
    transform: scale(1.1);
}
/* Mobile –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è iPhone 14 –∏ –ø–æ–¥–æ–±–Ω—ã—Ö (390px - 428px —à–∏—Ä–∏–Ω–∞) */
@media (max-width: 900px) {
    .pulse-header {
        flex-wrap: wrap;
        gap: 1vh;
        padding: 1.2vh 3vw;
        min-height: auto;
    }
    
    .title-main { 
        font-size: 1.8vh; 
        letter-spacing: 0.1em;
    }
    
    .header-nav { 
        gap: 1.5vw; 
        flex-wrap: wrap;
        width: 100%;
        justify-content: center;
    }
    
    .logo-header {
        height: 5vh; 
        width: 5vh;
        min-width: 36px;
        min-height: 36px;
    }
    
    .nav-btn {
        padding: 0.8vh 2.5vw;
        font-size: 1.3vh;
        letter-spacing: 0.08em;
    }
    
    .music-icon-btn,
    .profile-btn {
        padding: 0.8vh 2vw !important;
        font-size: 2vh !important;
    }
}

/* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã (–º–µ–Ω—å—à–µ iPhone 14) */
@media (max-width: 480px) {
    .pulse-header {
        padding: 1vh 4vw;
    }
    
    .title-main { 
        font-size: 1.6vh; 
    }
    
    .header-nav { 
        gap: 1vw; 
    }
    
    .nav-btn {
        padding: 0.7vh 2vw;
        font-size: 1.2vh;
    }
    
    .logo-header {
        height: 4.5vh; 
        width: 4.5vh;
    }
}
</style>
<audio id="music-player" loop src="{{ url_for('static', filename='processed_audio.mp3') }}"></audio>
<script>
// Auto-authorize if opened via Telegram Web App
function initTelegramWebAppAuth() {
    // Check if Telegram Web App is available
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        console.log('üì± Telegram Web App detected');
        
        // Initialize Web App
        tg.ready();
        tg.expand();
        
        // Get user data from Telegram Web App
        const initData = tg.initData || '';
        const user = tg.initDataUnsafe?.user;
        
        if (user) {
            console.log('‚úÖ User data from Telegram Web App:', user);
            
            const telegramId = user.id.toString();
            const firstName = user.first_name || '';
            const lastName = user.last_name || '';
            const username = user.username || '';
            
            // Save to localStorage
            localStorage.setItem('pulse_telegram_id', telegramId);
            localStorage.setItem('pulse_player_name', firstName + (lastName ? ' ' + lastName : ''));
            if (username) {
                localStorage.setItem('pulse_telegram_username', username);
            }
            
            // Register user in database
            const registrationData = {
                telegram_id: telegramId,
                first_name: firstName,
                last_name: lastName || '',
                username: username,
                language_code: user.language_code || 'ru',
                is_bot: false,
                registration_source: 'telegram_webapp'
            };
            
            console.log('üì§ Auto-registering user from Telegram Web App:', registrationData);
            
            fetch('/api/telegram/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(registrationData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ User auto-registered from Telegram Web App:', data);
                // Check user status - don't show modals if already registered
                return fetch(`/api/telegram/user-status?telegram_id=${encodeURIComponent(telegramId)}`);
            })
            .then(response => response.json())
            .then(data => {
                console.log('üìã User status after auto-registration:', data);
                // Only show modals if user hasn't completed registration
                if (data.ok && data.offer_accepted && data.game_nickname) {
                    // User already registered - just reload profile
                    console.log('‚úÖ User already fully registered, skipping modals');
                    if (typeof loadProfileData === 'function') {
                        loadProfileData();
                    }
                } else if (data.ok && data.offer_accepted && !data.game_nickname) {
                    // Offer accepted but no nickname - show nickname modal
                    console.log('üìã Offer accepted but no nickname, showing nickname modal');
                    const nicknameModal = document.getElementById('nickname-modal');
                    if (nicknameModal) {
                        nicknameModal.style.display = 'block';
                        nicknameModal.classList.add('active');
                    }
                } else {
                    // Offer not accepted - show offer modal
                    console.log('üìã Offer not accepted, showing offer modal');
                    const offerModal = document.getElementById('offer-modal');
                    if (offerModal) {
                        offerModal.style.display = 'block';
                        offerModal.classList.add('active');
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå Error auto-registering user from Telegram Web App:', error);
            });
        } else {
            console.log('‚ö†Ô∏è No user data in Telegram Web App');
        }
    } else {
        console.log('üì± Telegram Web App not available (opened in regular browser)');
    }
}

document.addEventListener('DOMContentLoaded', function(){
    // Initialize Telegram Web App auth first
    initTelegramWebAppAuth();
    const audio = document.getElementById('music-player');
    const toggle = document.getElementById('music-toggle');
    if(!audio || !toggle) {
        console.warn('‚ö†Ô∏è Music player or toggle button not found');
        return;
    }
    let isPlaying = false;
    let savedTime = 0;
    const isTimerPage = window.location.pathname === '/timer';
    
    // Load saved state and time
    const storedTime = localStorage.getItem('pulse_music_time');
    const storedState = localStorage.getItem('pulse_music_enabled');
    // Check if music was explicitly disabled by user
    const wasDisabled = storedState === 'false';
    audio.volume = 1;
    
    // Check navigation type to determine if this is a page refresh or navigation
    const navEntry = performance.getEntriesByType('navigation')[0];
    const isPageRefresh = navEntry && (navEntry.type === 'reload' || navEntry.type === 'navigate');
    const wasNavigated = sessionStorage.getItem('pulse_navigated');
    
    // If page was refreshed (not navigated from another page), reset music
    if (isPageRefresh && !wasNavigated) {
        // Page refresh - start music from beginning (only if not disabled by user)
        if (!wasDisabled) {
            audio.currentTime = 0;
            savedTime = 0;
            localStorage.removeItem('pulse_music_time');
        } else {
            // Music was disabled - keep it disabled, don't reset time
            savedTime = storedTime ? parseFloat(storedTime) : 0;
            audio.currentTime = savedTime;
        }
        sessionStorage.setItem('pulse_navigated', 'true');
    } else {
        // Navigation between pages - continue from saved time
        savedTime = storedTime ? parseFloat(storedTime) : 0;
        audio.currentTime = savedTime;
        sessionStorage.setItem('pulse_navigated', 'true');
    }
    
    // Auto-play on all pages except timer (only if music was not disabled by user)
    if (!isTimerPage && !wasDisabled) {
        // Set volume to 50%
        audio.volume = 1;
        // Try to play music automatically
        audio.play().then(()=>{
            isPlaying = true;
            if(toggle && toggle.querySelector('.music-icon')) {
                toggle.querySelector('.music-icon').textContent = 'üîä';
            }
            // Mark as enabled if it plays successfully
            localStorage.setItem('pulse_music_enabled', 'true');
        }).catch(()=>{
            // Auto-play blocked by browser (needs user interaction)
            // This is normal - user can click to play
            if(toggle && toggle.querySelector('.music-icon')) {
                toggle.querySelector('.music-icon').textContent = 'üîá';
            }
        });
    } else if (isTimerPage) {
        // On timer page, pause music (but don't mark as disabled)
        audio.pause();
        savedTime = audio.currentTime;
        isPlaying = false;
        if(toggle && toggle.querySelector('.music-icon')) {
            toggle.querySelector('.music-icon').textContent = 'üîá';
        }
        // Save time when leaving timer page
        localStorage.setItem('pulse_music_time', savedTime);
    } else {
        // Music was disabled by user - don't auto-play
        audio.pause();
        isPlaying = false;
        if(toggle && toggle.querySelector('.music-icon')) {
            toggle.querySelector('.music-icon').textContent = 'üîá';
        }
    }
    
    toggle.addEventListener('click', function(e){
        e.preventDefault();
        if(!isPlaying){
            // Set volume to 50%
            audio.volume = 1;
            // Continue from saved time
            audio.currentTime = savedTime || 0;
            audio.play().then(()=>{
                isPlaying = true;
                toggle.querySelector('.music-icon').textContent = 'üîä';
                localStorage.setItem('pulse_music_enabled', 'true');
            }).catch(()=>{
                alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
            });
        } else {
            audio.pause();
            savedTime = audio.currentTime;
            isPlaying = false;
            toggle.querySelector('.music-icon').textContent = 'üîá';
            localStorage.setItem('pulse_music_enabled', 'false');
            localStorage.setItem('pulse_music_time', savedTime);
        }
    });
    
    // Save time periodically when playing (for navigation between pages)
    setInterval(function(){
        if(isPlaying && audio.currentTime > 0){
            savedTime = audio.currentTime;
            // Save to localStorage so music continues between page navigations
            localStorage.setItem('pulse_music_time', savedTime);
        }
    }, 1000);
    
    window.addEventListener('beforeunload', function(){
        // Save current state when leaving page
        if(isPlaying){
            savedTime = audio.currentTime;
            localStorage.setItem('pulse_music_time', savedTime);
            localStorage.setItem('pulse_music_enabled', 'true');
        } else {
            // Only save as disabled if user manually disabled it (not if on timer page)
            if(!isTimerPage){
                localStorage.setItem('pulse_music_enabled', 'false');
            }
            // Still save time even if paused, so it can resume later
            if(savedTime > 0){
                localStorage.setItem('pulse_music_time', savedTime);
            }
        }
        // Mark that we're navigating (not refreshing) - this will be cleared on refresh
        // We keep it in sessionStorage to distinguish navigation from refresh
    });
    
    // Clear navigation flag on page refresh (F5, Ctrl+R)
    // This allows us to detect refresh vs navigation
    window.addEventListener('pageshow', function(event) {
        // If page was loaded from cache (back/forward), keep navigation flag
        // If page was loaded fresh (refresh), clear it
        if (event.persisted) {
            // Page loaded from cache (back/forward navigation)
            // Keep navigation flag so splash doesn't show
        } else {
            // Check if this is a refresh by looking at navigation type
            const navEntry = performance.getEntriesByType('navigation')[0];
            if (navEntry && navEntry.type === 'reload') {
                // This is a refresh - clear navigation flag so splash shows
                sessionStorage.removeItem('pulse_navigated');
            }
        }
    });
    
    // Check admin status on page load
    (function() {
        const telegramId = localStorage.getItem('pulse_telegram_id');
        if (telegramId) {
            // Wait a bit for DOM to be ready
            setTimeout(function() {
                checkAdminStatus(telegramId);
            }, 500);
        }
    })();
    
    // Profile modal
    const profileToggle = document.getElementById('profile-toggle');
    const profileModal = document.getElementById('profile-modal');
    const profileClose = document.getElementById('profile-close');
    const profileBackdrop = document.getElementById('profile-backdrop');
    
    function loadProfileData() {
        const telegramId = localStorage.getItem('pulse_telegram_id') || '';
        const profileNameEl = document.getElementById('profile-name');
        const profileTelegramEl = document.getElementById('profile-telegram');
        const profileEditBtn = document.getElementById('profile-edit-name-btn');
        const authStatusText = document.getElementById('auth-status-text');
        const telegramWidgetContainer = document.getElementById('telegram-widget-container');
        
        // Show loading state
        if (profileNameEl) profileNameEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        if (profileTelegramEl) profileTelegramEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        if (authStatusText) authStatusText.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...';
        
        // If we have telegram_id, check if user exists in database
        if (telegramId) {
            fetch(`/api/telegram/user-status?telegram_id=${encodeURIComponent(telegramId)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        // User exists in database - hide widget, show authorized status
                        if (telegramWidgetContainer) telegramWidgetContainer.style.display = 'none';
                        if (authStatusText) {
                            authStatusText.textContent = '‚úÖ –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã';
                            authStatusText.style.color = '#4ade80';
                        }
                        
                        // Update localStorage with server data
                        const fullName = data.first_name + (data.last_name ? ' ' + data.last_name : '');
                        localStorage.setItem('pulse_player_name', fullName || '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                        if (data.username) {
                            localStorage.setItem('pulse_telegram_username', data.username);
                        }
                        // Check admin status after loading user data
                        if (telegramId) {
                            checkAdminStatus(telegramId);
                        }
                        
                        // Update display - show game_nickname instead of first_name
                        if (profileNameEl) {
                            const displayName = data.game_nickname || '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
                            profileNameEl.textContent = displayName;
                        }
                        // Show edit button if user has game_nickname
                        if (profileEditBtn && data.game_nickname && data.game_nickname !== '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω') {
                            profileEditBtn.style.display = 'block';
                        }
                        if (profileTelegramEl) {
                            if (data.username) {
                                profileTelegramEl.textContent = '@' + data.username;
                            } else if (telegramId) {
                                profileTelegramEl.textContent = 'ID: ' + telegramId;
                            } else {
                                profileTelegramEl.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω';
                            }
                        }
                    } else {
                        // User not in database - show widget for registration
                        if (telegramWidgetContainer) telegramWidgetContainer.style.display = 'block';
                        if (authStatusText) {
                            authStatusText.textContent = 'üîê –î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ (/start)';
                            authStatusText.style.color = 'var(--text-muted)';
                        }
                        
                        // Fallback to localStorage if server request fails
                        const playerName = localStorage.getItem('pulse_player_name') || '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
                        const telegramUsername = localStorage.getItem('pulse_telegram_username') || '';
                        
                        if (profileNameEl) profileNameEl.textContent = playerName;
                        if (profileEditBtn && playerName && playerName !== '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω') {
                            profileEditBtn.style.display = 'block';
                        }
                        if (profileTelegramEl) {
                            if (telegramUsername) {
                                profileTelegramEl.textContent = '@' + telegramUsername;
                            } else if (telegramId) {
                                profileTelegramEl.textContent = 'ID: ' + telegramId;
                            } else {
                                profileTelegramEl.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    // On error, show widget
                    if (telegramWidgetContainer) telegramWidgetContainer.style.display = 'block';
                    if (authStatusText) {
                        authStatusText.textContent = 'üîê –î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ (/start)';
                        authStatusText.style.color = 'var(--text-muted)';
                    }
                    
                    // Fallback to localStorage
                    const playerName = localStorage.getItem('pulse_player_name') || '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
                    const telegramUsername = localStorage.getItem('pulse_telegram_username') || '';
                    
                    if (profileNameEl) profileNameEl.textContent = playerName;
                    if (profileEditBtn && playerName && playerName !== '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω') {
                        profileEditBtn.style.display = 'block';
                    }
                    if (profileTelegramEl) {
                        if (telegramUsername) {
                            profileTelegramEl.textContent = '@' + telegramUsername;
                        } else if (telegramId) {
                            profileTelegramEl.textContent = 'ID: ' + telegramId;
                        } else {
                            profileTelegramEl.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω';
                        }
                    }
                });
        } else {
            // No telegram_id - show widget
            if (telegramWidgetContainer) telegramWidgetContainer.style.display = 'block';
            if (authStatusText) {
                authStatusText.textContent = 'üîê –î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ (/start)';
                authStatusText.style.color = 'var(--text-muted)';
            }
            
            // No telegram_id, show default
            const playerName = localStorage.getItem('pulse_player_name') || '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
            const telegramUsername = localStorage.getItem('pulse_telegram_username') || '';
            
            if (profileNameEl) profileNameEl.textContent = playerName;
            if (profileEditBtn && playerName && playerName !== '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω') {
                profileEditBtn.style.display = 'block';
            }
            if (profileTelegramEl) {
                if (telegramUsername) {
                    profileTelegramEl.textContent = '@' + telegramUsername;
                } else {
                    profileTelegramEl.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω';
                }
            }
        }
    }
    
    // Handle name editing
    $(document).ready(function() {
        $('#profile-edit-name-btn').on('click', function() {
            const profileNameEl = document.getElementById('profile-name');
            const profileNameEdit = document.getElementById('profile-name-edit');
            const profileNameInput = document.getElementById('profile-name-input');
            const profileInfoItem = profileNameEl ? profileNameEl.closest('.profile-info-item') : null;
            
            if (profileNameEl && profileNameEdit && profileNameInput) {
                // Hide display, show edit
                if (profileInfoItem) profileInfoItem.style.display = 'none';
                profileNameEdit.style.display = 'flex';
                profileNameInput.value = profileNameEl.textContent || '';
                profileNameInput.focus();
            }
        });
        
        $('#profile-name-save').on('click', function() {
            const telegramId = localStorage.getItem('pulse_telegram_id');
            const profileNameInput = document.getElementById('profile-name-input');
            const displayName = profileNameInput ? profileNameInput.value.trim() : '';
            
            if (!telegramId) {
                alert('Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            if (!displayName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                return;
            }
            
            if (displayName.length > 50) {
                alert('–ò–º—è –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            $.ajax({
                url: '/api/telegram/set-name',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    telegram_id: telegramId,
                    display_name: displayName
                })
            })
            .done(function(data) {
                if (data.ok) {
                    console.log('‚úÖ Display name saved successfully');
                    // Update display
                    const profileNameEl = document.getElementById('profile-name');
                    const profileNameEdit = document.getElementById('profile-name-edit');
                    const profileInfoItem = profileNameEl ? profileNameEl.closest('.profile-info-item') : null;
                    
                    if (profileNameEl) {
                        profileNameEl.textContent = displayName;
                        localStorage.setItem('pulse_player_name', displayName);
                    }
                    
                    // Hide edit, show display
                    if (profileNameEdit) profileNameEdit.style.display = 'none';
                    if (profileInfoItem) profileInfoItem.style.display = 'flex';
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .fail(function() {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏');
            });
        });
        
        $('#profile-name-cancel').on('click', function() {
            const profileNameEdit = document.getElementById('profile-name-edit');
            const profileNameEl = document.getElementById('profile-name');
            const profileInfoItem = profileNameEl ? profileNameEl.closest('.profile-info-item') : null;
            
            // Hide edit, show display
            if (profileNameEdit) profileNameEdit.style.display = 'none';
            if (profileInfoItem) profileInfoItem.style.display = 'flex';
        });
    });
    
    // Define onTelegramAuth BEFORE widget initialization to ensure it's available
    // Telegram auth callback - simple version as in Telegram docs
    console.log('üîß Defining window.onTelegramAuth function...');
    
    // Make sure it's globally accessible
    window.onTelegramAuth = function(user) {
        console.log('üéâ === Telegram auth callback received ===', user);
        console.log('üéâ Callback function called! User data:', JSON.stringify(user, null, 2));
        console.log('User object:', JSON.stringify(user, null, 2));
        
        if (!user || !user.id) {
            console.error('Invalid user data received from Telegram');
            alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            return;
        }
        
        // Immediately save to localStorage for quick display
        const playerName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        const telegramUsername = user.username || '';
        const telegramId = user.id.toString();
        
        console.log('Saving to localStorage:', {
            playerName,
            telegramId,
            telegramUsername
        });
        
        localStorage.setItem('pulse_player_name', playerName);
        localStorage.setItem('pulse_telegram_id', telegramId);
        if (telegramUsername) {
            localStorage.setItem('pulse_telegram_username', telegramUsername);
        }
        
        // Update profile display immediately
        const profileNameEl = document.getElementById('profile-name');
        const profileTelegramEl = document.getElementById('profile-telegram');
        if (profileNameEl) {
            profileNameEl.textContent = playerName;
            console.log('Updated profile name:', playerName);
        }
        if (profileTelegramEl) {
            const displayText = telegramUsername ? '@' + telegramUsername : 'ID: ' + telegramId;
            profileTelegramEl.textContent = displayText;
            console.log('Updated profile telegram:', displayText);
        }
        
        // First register user in database, then check offer status
        console.log('üìù Registering user first, then checking offer status...');
        registerUserThenCheckOffer(user);
    };
    
    // Register user first, then check offer status
    function registerUserThenCheckOffer(user) {
        const telegramId = user.id.toString();
        const playerName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        const telegramUsername = user.username || '';
        
        const registrationData = {
            telegram_id: telegramId,
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            username: telegramUsername,
            language_code: user.language_code || 'ru',
            is_bot: false,
            registration_source: 'telegram_widget'
        };
        
        console.log('üì§ Registering user in database:', registrationData);
        
        // Register user on server first
        fetch('/api/telegram/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(registrationData)
        })
        .then(response => {
            console.log('Registration response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ User registered in database:', data);
            
            // Now check offer status
            return fetch(`/api/telegram/user-status?telegram_id=${encodeURIComponent(telegramId)}`);
        })
        .then(response => response.json())
        .then(data => {
            console.log('üìã User status from server:', data);
            
            if (data.ok && data.offer_accepted) {
                // Offer already accepted, proceed with nickname check
                console.log('‚úÖ Offer already accepted');
                if (!data.game_nickname) {
                    // Show nickname modal
                    console.log('üìã No nickname set, showing nickname modal');
                    const nicknameModal = document.getElementById('nickname-modal');
                    if (nicknameModal) {
                        nicknameModal.style.display = 'block';
                        nicknameModal.classList.add('active');
                    }
                } else {
                    // All set
                    console.log('‚úÖ All set, user is ready');
                    loadProfileData();
                    if (telegramId && typeof checkAdminStatus === 'function') {
                        checkAdminStatus(telegramId);
                    }
                }
            } else {
                // Offer not accepted, show offer modal
                console.log('üìã Offer not accepted, showing offer modal');
                showOfferModal(user);
            }
        })
        .catch(error => {
            console.error('‚ùå Error during registration or status check:', error);
            // If registration fails, still try to show offer modal
            showOfferModal(user);
        });
    }
    
    // Show offer modal and handle acceptance
    function showOfferModal(user) {
        const offerModal = document.getElementById('offer-modal');
        if (!offerModal) {
            console.error('‚ùå Offer modal not found');
            // If modal not found, proceed with registration anyway
            processTelegramAuth(user);
            return;
        }
        
        // Store user data temporarily to use after offer acceptance
        window._pendingTelegramUser = user;
        
        // Show offer modal
        offerModal.style.display = 'block';
        offerModal.classList.add('active');
        
        // Handle offer acceptance
        const offerAcceptBtn = document.getElementById('offer-accept-btn');
        const offerRejectBtn = document.getElementById('offer-reject-btn');
        
        if (offerAcceptBtn) {
            // Remove old listeners
            const newAcceptBtn = offerAcceptBtn.cloneNode(true);
            offerAcceptBtn.parentNode.replaceChild(newAcceptBtn, offerAcceptBtn);
            
            newAcceptBtn.addEventListener('click', function() {
                console.log('‚úÖ Offer accepted, proceeding with registration');
                acceptOfferAndRegister(user);
            });
        }
        
        if (offerRejectBtn) {
            // Remove old listeners
            const newRejectBtn = offerRejectBtn.cloneNode(true);
            offerRejectBtn.parentNode.replaceChild(newRejectBtn, offerRejectBtn);
            
            newRejectBtn.addEventListener('click', function() {
                console.log('‚ùå Offer rejected, deleting user data');
                const telegramId = user.id.toString();
                
                // Delete user data from server
                fetch('/api/telegram/delete-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: telegramId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        console.log('‚úÖ User data deleted from server');
                        // Clear localStorage
                        localStorage.removeItem('pulse_player_name');
                        localStorage.removeItem('pulse_telegram_id');
                        localStorage.removeItem('pulse_telegram_username');
                        // Close modal
                        const offerModal = document.getElementById('offer-modal');
                        if (offerModal) {
                            offerModal.style.display = 'none';
                            offerModal.classList.remove('active');
                        }
                        // Update profile display
                        loadProfileData();
                    } else {
                        console.error('‚ùå Error deleting user:', data.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error deleting user:', error);
                });
            });
        }
    }
    
    // Accept offer and register user
    function acceptOfferAndRegister(user) {
        const telegramId = user.id.toString();
        
        // Accept offer on server
        fetch('/api/telegram/accept-offer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                telegram_id: telegramId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                console.log('‚úÖ Offer accepted on server');
                // Close offer modal
                const offerModal = document.getElementById('offer-modal');
                if (offerModal) {
                    offerModal.style.display = 'none';
                    offerModal.classList.remove('active');
                }
                // Now proceed with registration
                processTelegramAuth(user);
            } else {
                console.error('‚ùå Error accepting offer:', data.error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –æ—Ñ–µ—Ä—Ç—ã: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('‚ùå Error accepting offer:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –æ—Ñ–µ—Ä—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
    }
    
    // Telegram Login Widget
    function initTelegramWidget() {
        console.log('üîß initTelegramWidget called');
        
        const container = document.getElementById('telegram-widget-container');
        if (!container) {
            console.error('‚ùå telegram-widget-container not found!');
            return;
        }
        
        console.log('‚úÖ Container found:', container);
        
        // Verify onTelegramAuth is defined
        if (typeof window.onTelegramAuth !== 'function') {
            console.error('‚ùå window.onTelegramAuth is not a function!', typeof window.onTelegramAuth);
            container.innerHTML = '<div style="text-align: center; padding: 2vh; color: var(--accent-soft); font-size: 1.3vh;">‚ùå –û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è onTelegramAuth –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
            return;
        }
        console.log('‚úÖ window.onTelegramAuth is defined');
        
        // Remove existing widget if any
        const existingScript = document.querySelector('script[data-telegram-login]');
        if (existingScript) {
            console.log('üóëÔ∏è Removing existing widget script');
            existingScript.remove();
        }
        
        // Clear container
        container.innerHTML = '<div style="text-align: center; padding: 2vh; color: var(--text-muted); font-size: 1.3vh;">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–∂–µ—Ç–∞...</div>';
        
        // Check current domain
        const currentDomain = window.location.hostname;
        const isLocalhost = currentDomain === 'localhost' || currentDomain === '127.0.0.1' || currentDomain.startsWith('192.168.');
        
        console.log('üåê Current domain:', currentDomain, 'isLocalhost:', isLocalhost);
        
        // Show domain registration notice if needed
        if (isLocalhost) {
            container.innerHTML = '<div style="text-align: center; padding: 2vh; color: var(--text-muted); font-size: 1.3vh; line-height: 1.6;">‚ö†Ô∏è –í–∏–¥–∂–µ—Ç Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –¥–æ–º–µ–Ω–µ.<br><br>–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:<br><code style="background: rgba(0,0,0,0.3); padding: 0.5vh 1vw; border-radius: 4px;">localhost</code><br><br>–ò–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –¥–æ–º–µ–Ω —á–µ—Ä–µ–∑ @BotFather:<br><code style="background: rgba(0,0,0,0.3); padding: 0.5vh 1vw; border-radius: 4px;">/setdomain</code></div>';
            return;
        }
        
        // Create widget script exactly as in Telegram documentation
        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://telegram.org/js/telegram-widget.js?22';
        script.setAttribute('data-telegram-login', 'Pulse_Club_bot');
        script.setAttribute('data-size', 'large');
        script.setAttribute('data-radius', '20');
        script.setAttribute('data-onauth', 'onTelegramAuth');
        script.setAttribute('data-request-access', 'write');
        
        console.log('üìù Widget script attributes set:', {
            'data-telegram-login': 'Pulse_Club_bot',
            'data-size': 'large',
            'data-onauth': 'onTelegramAuth'
        });
        
        // Handle widget script load
        script.onload = function() {
            console.log('‚úÖ Telegram widget script loaded successfully');
            // Check if widget rendered
            setTimeout(function() {
                const widgetButton = container.querySelector('iframe, .tgme_widget_login_button, button');
                if (widgetButton) {
                    console.log('‚úÖ Widget button found:', widgetButton);
                    
                    // Add click listener to detect if button is clicked
                    if (widgetButton.tagName === 'IFRAME') {
                        console.log('üìã Widget is an iframe, monitoring for messages...');
                        
                        // Listen for messages from iframe (Telegram widget sends messages)
                        window.addEventListener('message', function(event) {
                            console.log('üì® Message received from iframe:', event);
                            console.log('üì® Origin:', event.origin);
                            console.log('üì® Data:', event.data);
                            
                            // Telegram widget sends data via postMessage
                            if (event.origin === 'https://oauth.telegram.org' && event.data) {
                                console.log('‚úÖ Message from Telegram OAuth:', event.data);
                                
                                let userData = null;
                                
                                // Parse data if it's a string
                                let parsedData = event.data;
                                if (typeof event.data === 'string') {
                                    try {
                                        parsedData = JSON.parse(event.data);
                                        console.log('üìã Parsed data:', parsedData);
                                    } catch (e) {
                                        console.error('‚ùå Failed to parse JSON:', e);
                                        return;
                                    }
                                }
                                
                                // Check for auth_data in the parsed data
                                if (parsedData && parsedData.auth_data) {
                                    userData = parsedData.auth_data;
                                    console.log('üéâ User data extracted from auth_data:', userData);
                                } else if (parsedData && parsedData.id) {
                                    // Direct user data
                                    userData = parsedData;
                                    console.log('üéâ User data found directly:', userData);
                                } else if (parsedData && parsedData.user) {
                                    userData = parsedData.user;
                                    console.log('üéâ User data found in user field:', userData);
                                }
                                
                                // Process user data if found
                                if (userData && userData.id) {
                                    console.log('üéâ User data received via postMessage:', userData);
                                    console.log('üéâ Calling onTelegramAuth with:', userData);
                                    
                                    if (typeof window.onTelegramAuth === 'function') {
                                        window.onTelegramAuth(userData);
                                    } else {
                                        console.error('‚ùå window.onTelegramAuth is not a function!');
                                    }
                                } else {
                                    // This is normal - not all messages from iframe contain user data
                                    // Only log if it's actually a Telegram-related message
                                    if (event.data && typeof event.data === 'object' && event.data.type) {
                                        console.log('üì® Message from iframe (not user data):', event.data.type);
                                    }
                                }
                            }
                        });
                    }
                } else {
                    console.warn('‚ö†Ô∏è Widget button not found after load');
                }
                
                // Check for errors after a longer delay
                setTimeout(function() {
                    const widgetError = container.querySelector('.tgme_widget_error, [class*="error"]');
                    if (widgetError) {
                        const errorText = widgetError.textContent || widgetError.innerText || '';
                        console.error('‚ùå Widget error detected:', errorText);
                        if (errorText.includes('domain') || errorText.includes('invalid') || errorText.includes('Domain')) {
                            console.error('‚ùå DOMAIN NOT REGISTERED!');
                            console.error('üí° Register domain via @BotFather: /setdomain');
                            console.error('üí° Current domain:', currentDomain);
                        }
                    } else {
                        console.log('‚úÖ No widget errors detected');
                    }
                }, 3000);
            }, 1000);
        };
        
        // Handle widget errors
        script.onerror = function() {
            console.error('‚ùå Failed to load Telegram widget script');
            container.innerHTML = '<div style="text-align: center; padding: 2vh; color: var(--accent-soft); font-size: 1.3vh; line-height: 1.6;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ Telegram.<br><br>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–º–µ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ @BotFather:<br><code style="background: rgba(0,0,0,0.3); padding: 0.5vh 1vw; border-radius: 4px;">/setdomain</code><br><br>–¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω: <code style="background: rgba(0,0,0,0.3); padding: 0.5vh 1vw; border-radius: 4px;">' + currentDomain + '</code></div>';
        };
        
        // Check for domain errors after widget loads
        setTimeout(function() {
            const widgetError = container.querySelector('.tgme_widget_error');
            if (widgetError) {
                const errorText = widgetError.textContent || '';
                console.error('‚ùå Widget error detected:', errorText);
                if (errorText.includes('domain') || errorText.includes('invalid')) {
                    container.innerHTML = '<div style="text-align: center; padding: 2vh; color: var(--accent-soft); font-size: 1.3vh; line-height: 1.6;">‚ö†Ô∏è –î–æ–º–µ–Ω –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –±–æ—Ç–µ.<br><br>–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ–º–µ–Ω–∞:<br>1. –û—Ç–∫—Ä–æ–π—Ç–µ @BotFather –≤ Telegram<br>2. –í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ <code style="background: rgba(0,0,0,0.3); padding: 0.5vh 1vw; border-radius: 4px;">Pulse_Club_bot</code><br>3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <code style="background: rgba(0,0,0,0.3); padding: 0.5vh 1vw; border-radius: 4px;">/setdomain</code><br>4. –£–∫–∞–∂–∏—Ç–µ –¥–æ–º–µ–Ω: <code style="background: rgba(0,0,0,0.3); padding: 0.5vh 1vw; border-radius: 4px;">' + currentDomain + '</code></div>';
                }
            } else {
                console.log('‚úÖ No widget errors detected');
            }
        }, 2000);
        
        console.log('üì§ Appending widget script to container');
        container.appendChild(script);
        console.log('‚úÖ Widget script appended');
    }
    
    // Process Telegram authentication - register user and show modals if needed
    function processTelegramAuth(user) {
        console.log('=== processTelegramAuth called ===', user);
        
        const playerName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        const telegramUsername = user.username || '';
        const telegramId = user.id.toString();
        
        const registrationData = {
            telegram_id: telegramId,
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            username: telegramUsername,
            language_code: user.language_code || 'ru',
            is_bot: false,
            registration_source: 'telegram_widget'
        };
        
        console.log('Sending registration data to server:', registrationData);
        
        // Register user on server
        fetch('/api/telegram/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(registrationData)
        })
        .then(response => {
            console.log('Registration response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Registration response data:', data);
            if (data.ok) {
                console.log('‚úÖ User registered successfully in database');
                
                // Check user status BEFORE showing modals
                return fetch(`/api/telegram/user-status?telegram_id=${encodeURIComponent(telegramId)}`);
            } else {
                throw new Error(data.error || 'Registration failed');
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('üìã User status after registration:', data);
            
            if (data.ok && data.offer_accepted && data.game_nickname) {
                // User already fully registered - don't show modals
                console.log('‚úÖ User already fully registered (offer accepted + nickname set), skipping modals');
                alert('‚úÖ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
                
                // Update profile display
                loadProfileData();
                
                // Check admin status
                if (telegramId && typeof checkAdminStatus === 'function') {
                    checkAdminStatus(telegramId);
                }
                return;
            }
            
            if (data.ok && data.offer_accepted && !data.game_nickname) {
                // Offer accepted but no nickname - show nickname modal
                console.log('üìã Offer accepted but no nickname, showing nickname modal');
                alert('‚úÖ –û—Ñ–µ—Ä—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫–Ω–µ–π–º.');
                
                // Show nickname modal - user must set nickname
                const nicknameModal = document.getElementById('nickname-modal');
                if (nicknameModal) {
                    nicknameModal.style.display = 'block';
                    nicknameModal.classList.add('active');
                }
                return;
            }
            
            if (!data.ok || !data.offer_accepted) {
                // Offer not accepted - show offer modal
                console.log('üìã Offer not accepted, showing offer modal');
                alert('–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –ø—É–±–ª–∏—á–Ω—É—é –æ—Ñ–µ—Ä—Ç—É.');
                
                const offerModal = document.getElementById('offer-modal');
                if (offerModal) {
                    offerModal.style.display = 'block';
                    offerModal.classList.add('active');
                }
                return;
            }
        })
        .catch(error => {
            console.error('‚ùå Error during registration or status check:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
    }
    
    // Check admin status and update UI
    function checkAdminStatus(telegramId) {
        console.log('üîç checkAdminStatus called with telegramId:', telegramId);
        
        if (!telegramId) {
            console.warn('‚ö†Ô∏è No telegram_id provided to checkAdminStatus');
            return;
        }
        
        const url = '/api/telegram/check-admin?telegram_id=' + encodeURIComponent(telegramId);
        console.log('üì° Fetching:', url);
        
        fetch(url)
            .then(response => {
                console.log('üì° Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üì° Response data:', data);
                
                if (data.ok && data.is_admin) {
                    console.log('‚úÖ Admin access granted for telegram_id:', telegramId);
                    
                    // Update IS_ADMIN on all pages
                    // Use window.PULSE_TIMER_IS_ADMIN instead of trying to modify const
                    if (typeof window.PULSE_TIMER_IS_ADMIN !== 'undefined') {
                        window.PULSE_TIMER_IS_ADMIN = true;
                        console.log('‚úÖ PULSE_TIMER_IS_ADMIN set to true');
                    }
                    // Also update IS_ADMIN if it's a variable (not const)
                    try {
                        if (typeof IS_ADMIN !== 'undefined' && typeof IS_ADMIN === 'boolean') {
                            // Try to update via window object if available
                            if (typeof window !== 'undefined') {
                                window.IS_ADMIN = true;
                                console.log('‚úÖ window.IS_ADMIN set to true');
                            }
                        }
                    } catch (e) {
                        // IS_ADMIN is const, can't modify - that's OK, use PULSE_TIMER_IS_ADMIN instead
                        console.log('‚ÑπÔ∏è IS_ADMIN is const, using PULSE_TIMER_IS_ADMIN instead');
                    }
                    
                    // Show admin panels
                    const adminPanels = document.querySelectorAll('#admin-panel');
                    adminPanels.forEach(panel => {
                        if (panel) {
                            panel.style.display = 'block';
                            console.log('‚úÖ Admin panel shown');
                        }
                    });
                    
                    const toggleAdminBtns = document.querySelectorAll('#toggle-admin');
                    toggleAdminBtns.forEach(btn => {
                        if (btn) {
                            btn.style.display = 'block';
                            console.log('‚úÖ Admin toggle button shown');
                        }
                    });
                    
                    // Show add event buttons
                    const addEventBtns = document.querySelectorAll('.add-event-btn');
                    addEventBtns.forEach(btn => {
                        if (btn) {
                            btn.style.display = 'block';
                            console.log('‚úÖ Add event button shown');
                        }
                    });
                    
                    console.log('‚úÖ Admin status updated successfully for telegram_id:', telegramId);
                } else {
                    console.warn('‚ö†Ô∏è User is not admin for telegram_id:', telegramId);
                    console.warn('‚ö†Ô∏è Admin list:', data.admin_list);
                }
            })
            .catch(error => {
                console.error('‚ùå Error checking admin status:', error);
            });
    }
    
    if (profileToggle && profileModal) {
        profileToggle.addEventListener('click', function() {
            profileModal.classList.add('active');
            profileBackdrop.classList.add('active');
            loadProfileData();
            // Check admin status when opening profile
            const telegramId = localStorage.getItem('pulse_telegram_id');
            if (telegramId) {
                checkAdminStatus(telegramId);
            }
            // Initialize Telegram widget when modal opens (with delay to ensure DOM is ready)
            console.log('üë§ Profile modal opened, initializing Telegram widget...');
            setTimeout(function() {
                console.log('‚è∞ Timeout fired, calling initTelegramWidget...');
                initTelegramWidget();
            }, 200);
        });
        
        if (profileClose) {
            profileClose.addEventListener('click', function() {
                profileModal.classList.remove('active');
                profileBackdrop.classList.remove('active');
            });
        }
        
        if (profileBackdrop) {
            profileBackdrop.addEventListener('click', function() {
                profileModal.classList.remove('active');
                profileBackdrop.classList.remove('active');
            });
        }
    }
    
});
</script>

<!-- Profile Modal -->
<div id="profile-backdrop" class="profile-backdrop"></div>
<div id="profile-modal" class="profile-modal">
    <div class="profile-modal-content">
        <div class="profile-modal-header">
            <h2 class="profile-modal-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
            <button class="profile-modal-close" id="profile-close">&times;</button>
        </div>
        <div class="profile-modal-body">
            <div class="profile-info">
                <div class="profile-info-item">
                    <span class="profile-info-label">–ò–º—è:</span>
                    <div style="display: flex; align-items: center; gap: 1vw; flex: 1;">
                        <span class="profile-info-value" id="profile-name" style="flex: 1;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        <button class="profile-edit-btn" id="profile-edit-name-btn" style="display: none; padding: 0.5vh 1vw; font-size: 1.2vh; background: rgba(255, 46, 59, 0.2); border: 1px solid var(--accent-dim); border-radius: 6px; color: var(--text); cursor: pointer; transition: all 0.2s;">‚úèÔ∏è</button>
                    </div>
                </div>
                <div class="profile-info-item" id="profile-name-edit" style="display: none;">
                    <span class="profile-info-label">–ò–º—è:</span>
                    <div style="display: flex; align-items: center; gap: 1vw; flex: 1;">
                        <input type="text" id="profile-name-input" class="event-form-input" style="flex: 1; padding: 1vh 1.5vw; font-size: 1.6vh;" maxlength="50">
                        <button class="event-form-btn event-form-btn-primary" id="profile-name-save" style="padding: 1vh 2vw; font-size: 1.4vh;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="event-form-btn event-form-btn-secondary" id="profile-name-cancel" style="padding: 1vh 2vw; font-size: 1.4vh;">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
                <div class="profile-info-item">
                    <span class="profile-info-label">Telegram:</span>
                    <span class="profile-info-value" id="profile-telegram">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
            <div class="profile-actions" id="profile-auth-section">
                <div id="telegram-widget-container" style="display: none;"></div>
                <div id="profile-auth-status" style="margin-bottom: 1.5vh; padding: 1.5vh; background: rgba(0, 238, 255, 0.05); border-radius: 12px; border: 1px solid rgba(0, 238, 255, 0.2);">
                    <div style="font-size: 1.4vh; color: var(--text-muted); text-align: center;">
                        <span id="auth-status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.profile-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9998;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.profile-backdrop.active {
    opacity: 1;
    pointer-events: all;
}

.profile-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
}

.profile-modal.active {
    opacity: 1;
    pointer-events: all;
    transform: translate(-50%, -50%) scale(1);
}

.profile-modal-content {
    background: radial-gradient(circle at top, #171722, #050510 70%);
    border-radius: 22px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    padding: 3vh 3vw;
    max-width: 500px;
    width: 90vw;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.95);
}

.profile-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3vh;
    padding-bottom: 2vh;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.profile-modal-title {
    font-size: 3vh;
    font-weight: 900;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #ff4b5c;
    text-shadow: 0 0 20px rgba(255, 75, 92, 0.6);
}

.profile-modal-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 3vh;
    cursor: pointer;
    padding: 0;
    width: 3vh;
    height: 3vh;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

.profile-modal-close:hover {
    transform: scale(1.2);
    color: #ff4b5c;
}

.profile-info {
    margin-bottom: 3vh;
}

.profile-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5vh 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.profile-info-label {
    font-size: 1.6vh;
    color: #9ba1b6;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
}

.profile-info-value {
    font-size: 1.8vh;
    color: #fff;
    font-weight: 600;
}

.profile-actions {
    display: flex;
    flex-direction: column;
    gap: 1.5vh;
}

.profile-action-btn {
    padding: 1.5vh 2vw;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(8, 8, 16, 0.9);
    color: #fff;
    font-size: 1.6vh;
    font-weight: 600;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: all 0.3s ease;
}

.profile-action-btn:hover {
    border-color: #ff4b5c;
    background: rgba(255, 46, 59, 0.15);
    box-shadow: 0 0 20px rgba(255, 46, 59, 0.4);
    transform: translateY(-2px);
}

.profile-action-btn:active {
    transform: translateY(0);
}

.profile-action-btn-primary {
    background: rgba(255, 46, 59, 0.2);
    border-color: #ff4b5c;
}

.profile-action-btn-primary:hover {
    background: rgba(255, 46, 59, 0.3);
    box-shadow: 0 0 30px rgba(255, 46, 59, 0.6);
}
</style>

<!-- Offer Modal (available on all pages) -->
<div class="event-modal" id="offer-modal" style="display: none; z-index: 20000;">
    <div class="event-modal-content" style="max-width: 85vw; max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="event-modal-header">
            <div class="event-modal-title">–ü–£–ë–õ–ò–ß–ù–ê–Ø –û–§–ï–†–¢–ê</div>
            <button class="event-modal-close" id="offer-modal-close" style="display: none;">&times;</button>
        </div>
        <div style="padding: 2vh 3vw; color: var(--text); line-height: 1.8;">
            <p style="margin-bottom: 2vh; font-size: 1.6vh; color: var(--text-muted); text-align: center;">
                –î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –∏ –ø—Ä–∏–Ω—è—Ç—å –ø—É–±–ª–∏—á–Ω—É—é –æ—Ñ–µ—Ä—Ç—É.
            </p>
            <div style="margin-bottom: 2vh; border-radius: 12px; overflow: hidden; box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);">
                <iframe src="https://docs.google.com/document/d/1KgkvSh-Vtx4-EyCcaetlIUYkuATmTqS-/preview" 
                        style="width: 100%; height: 55vh; border: none; background: #fff;"></iframe>
            </div>
            <div style="display: flex; gap: 1vw; margin-top: 2vh;">
                <button class="event-form-btn event-form-btn-secondary" id="offer-decline" style="flex: 1;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                <button class="event-form-btn event-form-btn-primary" id="offer-accept" style="flex: 1;">–ü—Ä–∏–Ω—è—Ç—å –æ—Ñ–µ—Ä—Ç—É</button>
            </div>
        </div>
    </div>
</div>

<!-- Game Nickname Modal (available on all pages) -->
<div class="event-modal" id="nickname-modal" style="display: none; z-index: 20001;">
    <div class="event-modal-content" style="max-width: 500px;">
        <div class="event-modal-header">
            <div class="event-modal-title">–ò–ì–†–û–í–û–ô –ù–ò–ö–ù–ï–ô–ú</div>
            <button class="event-modal-close" id="nickname-modal-close">&times;</button>
        </div>
        <div style="padding: 2vh;">
            <p style="margin-bottom: 2vh; color: var(--text-muted); font-size: 1.4vh; text-align: center;">
                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ –∏–≥—Ä–æ–∫–æ–≤.
            </p>
            <div class="event-form-group">
                <label class="event-form-label">–ò–≥—Ä–æ–≤–æ–π –Ω–∏–∫–Ω–µ–π–º</label>
                <input type="text" class="event-form-input" id="game-nickname-input" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º (2-20 —Å–∏–º–≤–æ–ª–æ–≤)" 
                       maxlength="20" style="width: 100%;">
            </div>
            <div style="display: flex; gap: 1vw; margin-top: 2vh;">
                <button class="event-form-btn event-form-btn-secondary" id="nickname-cancel" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                <button class="event-form-btn event-form-btn-primary" id="nickname-save" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
// Offer and Nickname modal handlers (available on all pages)
// Wait for jQuery to be loaded
(function() {
    function initModals() {
        if (typeof jQuery === 'undefined') {
            setTimeout(initModals, 100);
            return;
        }
        
        jQuery(document).ready(function($) {
    // Offer modal handlers
    $('#offer-accept').on('click', function() {
        const telegramId = localStorage.getItem('pulse_telegram_id');
        if (!telegramId) {
            alert('Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        $.ajax({
            url: '/api/telegram/accept-offer',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ telegram_id: telegramId })
        })
        .done(function(data) {
            if (data.ok) {
                $('#offer-modal').removeClass('active').hide();
                // Check if nickname is set
                $.ajax({
                    url: `/api/telegram/user-status?telegram_id=${telegramId}`,
                    method: 'GET'
                })
                .done(function(statusData) {
                    if (statusData.ok && !statusData.game_nickname) {
                        $('#nickname-modal').show().addClass('active');
                    }
                });
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .fail(function() {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –æ—Ñ–µ—Ä—Ç—ã');
        });
    });
    
    $('#offer-decline').on('click', function() {
        $('#offer-modal').removeClass('active').hide();
        alert('–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –ø—É–±–ª–∏—á–Ω—É—é –æ—Ñ–µ—Ä—Ç—É.');
    });
    
    // Nickname modal handlers
    $('#nickname-save').on('click', function() {
        const gameNickname = $('#game-nickname-input').val().trim();
        const telegramId = localStorage.getItem('pulse_telegram_id');
        
        if (!gameNickname) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫–Ω–µ–π–º');
            return;
        }
        
        // Validate length
        if (gameNickname.length < 2 || gameNickname.length > 20) {
            alert('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 2 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤');
            return;
        }
        
        // Allow letters (lat/cyrillic), numbers, underscore, and spaces
        if (!/^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_\s]+$/.test(gameNickname)) {
            alert('–ù–∏–∫–Ω–µ–π–º –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã (–ª–∞—Ç/–∫–∏—Ä–∏–ª–ª), —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ _');
            return;
        }
        
        // Don't allow only spaces
        if (!gameNickname.replace(/\s/g, '').replace(/_/g, '')) {
            alert('–ù–∏–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π');
            return;
        }
        
        if (!telegramId) {
            alert('Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        $.ajax({
            url: '/api/telegram/set-nickname',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                telegram_id: telegramId,
                game_nickname: gameNickname
            })
        })
        .done(function(data) {
            if (data.ok) {
                console.log('‚úÖ Nickname saved successfully');
                $('#nickname-modal').removeClass('active').hide();
                $('#game-nickname-input').val('');
                
                // Check admin status after nickname is set
                if (telegramId && typeof checkAdminStatus === 'function') {
                    checkAdminStatus(telegramId);
                }
                
                // Reload profile data
                if (typeof loadProfileData === 'function') {
                    loadProfileData();
                }
                
                if (window.location.pathname === '/' || window.location.pathname === '/dashboard') {
                    window.location.reload();
                }
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .fail(function() {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∏–∫–Ω–µ–π–º–∞');
        });
    });
    
    $('#nickname-cancel, #nickname-modal-close').on('click', function() {
        $('#nickname-modal').removeClass('active').hide();
    });
        });
    }
    initModals();
})();
</script>

<script>
// Suppress Google Docs iframe errors and other non-critical errors
(function() {
    // Suppress error events from iframes
    window.addEventListener('error', function(e) {
        if (e.message && (
            e.message.includes('filesystem:https://docs.google.com') ||
            e.message.includes('ERR_FILE_NOT_FOUND') ||
            e.message.includes('page_embed_script.js') ||
            e.message.includes('peoplestack-pa.client') ||
            e.filename && e.filename.includes('docs.google.com')
        )) {
            e.preventDefault();
            e.stopPropagation();
            return true;
        }
    }, true);
    
    // Suppress console errors from iframes
    const originalError = console.error;
    console.error = function(...args) {
        const message = args.join(' ');
        if (message.includes('filesystem:https://docs.google.com') ||
            message.includes('ERR_FILE_NOT_FOUND') ||
            message.includes('page_embed_script.js') ||
            message.includes('peoplestack-pa.client') ||
            message.includes('docs.google.com')) {
            return; // Suppress these errors
        }
        originalError.apply(console, args);
    };
    
    // Suppress resource loading errors
    window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && (
            e.reason.message && (
                e.reason.message.includes('docs.google.com') ||
                e.reason.message.includes('ERR_FILE_NOT_FOUND')
            )
        )) {
            e.preventDefault();
        }
    });
})();
</script>
